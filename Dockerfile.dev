ARG NODE_VERSION=24
ARG TOOL_VERSION=latest

FROM node:${NODE_VERSION}-slim

# Install curl and unzip
RUN apt-get update && apt-get install -y curl unzip && rm -rf /var/lib/apt/lists/*

# Download and install GeminiWatermarkTool
ARG TOOL_VERSION=latest
RUN if [ "$TOOL_VERSION" = "latest" ]; then \
      LATEST_TAG=$(curl -sL https://api.github.com/repos/allenk/GeminiWatermarkTool/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/'); \
      DOWNLOAD_URL="https://github.com/allenk/GeminiWatermarkTool/releases/download/${LATEST_TAG}/GeminiWatermarkTool-Linux-x64.zip"; \
    else \
      DOWNLOAD_URL="https://github.com/allenk/GeminiWatermarkTool/releases/download/${TOOL_VERSION}/GeminiWatermarkTool-Linux-x64.zip"; \
    fi && \
    if [ -n "$DOWNLOAD_URL" ]; then \
      curl -sL "$DOWNLOAD_URL" -o /tmp/tool.zip && \
      unzip -q /tmp/tool.zip -d /tmp && \
      find /tmp -name "GeminiWatermarkTool*" -type f -executable -exec mv {} /usr/local/bin/GeminiWatermarkTool \; && \
      chmod +x /usr/local/bin/GeminiWatermarkTool && \
      rm -rf /tmp/tool.zip /tmp/GeminiWatermarkTool*; \
    else \
      echo "Warning: Could not download GeminiWatermarkTool binary"; \
    fi

WORKDIR /app

# Copy package files and install dependencies
COPY package.json package-lock.json ./
RUN npm ci

# Create temp directory
RUN mkdir -p /tmp/gemini-watermark && chmod 777 /tmp/gemini-watermark

ENV NODE_ENV=development
ENV PORT=3000
ENV TEMP_DIR=/tmp/gemini-watermark

EXPOSE 3000

CMD ["npm", "run", "dev"]
